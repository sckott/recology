<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>finding truffles | Recology</title>
<meta name="keywords" content="R, testing, truffles">
<meta name="description" content="The bad thing about making software is that you can sometimes make it easier
for someone to shoot themselves in the foot. The good thing about software
is that you can make more software to help them not shoot a foot off.
The R package vcr, an R port of the Ruby library of the same name,
records and plays back HTTP requests. Some HTTP requests can have secrets (e.g.,
passwords, API keys, etc.) in their requests and/or responses. These secrets
can then accidentally end up on the Internet, where bad people may find them.
These secrets are sometimes called &ldquo;truffles&rdquo;.">
<meta name="author" content="Scott Chamberlain">
<link rel="canonical" href="http://localhost:1313/2020/01/test-truffles/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.f4cda22486791d430ef692108ba33a982c3c552eca57e99456bb55aa4bd22568.css" integrity="sha256-9M2iJIZ5HUMO9pIQi6M6mCw8VS7KV&#43;mUVrtVqkvSJWg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/2020/01/test-truffles/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Recology (Alt + H)">Recology</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/index.xml" title="RSS">
                    <span>RSS</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      finding truffles
    </h1>
    <div class="post-meta"><span title='2020-01-30 00:00:00 +0000 UTC'>January 30, 2020</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Scott Chamberlain

</div>
  </header> 
  <div class="post-content"><p>The bad thing about making software is that you can sometimes make it easier
for someone to shoot themselves in the foot. The good thing about software
is that you can make more software to help them not shoot a foot off.</p>
<p>The R package <a href="https://github.com/ropensci/vcr">vcr</a>, an R port of the <a href="https://github.com/vcr/vcr">Ruby library</a> of the same name,
records and plays back HTTP requests. Some HTTP requests can have secrets (e.g.,
passwords, API keys, etc.) in their requests and/or responses. These secrets
can then accidentally end up on the Internet, where bad people may find them.
These secrets are sometimes called &ldquo;truffles&rdquo;.</p>
<p>There&rsquo;s a suite of tools out there for finding these truffles (e.g.,
<a href="https://github.com/dxa4481/truffleHog">truffleHog</a>, <a href="https://github.com/awslabs/git-secrets">gitsecrets</a>) that use tools like regex and entropy.</p>
<p>Despite there being existing tools, users tend to use things that are
built in the language(s) they know; that are easy to incorporate into
their existing workflows. Towards this end, I&rsquo;ve been working on a new
R package <a href="https://github.com/ropenscilabs/trufflesniffer">trufflesniffer</a>.</p>
<p>trufflesniffer doesn&rsquo;t do any fancy entropy stuff, and doesn&rsquo;t try to
find secrets without any informed knowledge. Rather, the user supplies
the secrets that they want to look for and trufflesniffer looks for
them. In the future I&rsquo;d look to see if it can be used without
any user inputs.</p>
<p>terminology:</p>
<ul>
<li>sniff: search for a secret</li>
</ul>
<p>links:</p>
<ul>
<li>src: <a href="https://github.com/ropenscilabs/trufflesniffer">https://github.com/ropenscilabs/trufflesniffer</a></li>
<li>docs: <a href="https://docs.ropensci.org/trufflesniffer">https://docs.ropensci.org/trufflesniffer</a></li>
</ul>
<h2 id="install">Install<a hidden class="anchor" aria-hidden="true" href="#install">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>remotes<span style="color:#f92672">::</span><span style="color:#a6e22e">install_github</span>(<span style="color:#e6db74">&#34;ropenscilabs/trufflesniffer&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(trufflesniffer)
</span></span></code></pre></div><h2 id="directory">directory<a hidden class="anchor" aria-hidden="true" href="#directory">#</a></h2>
<p>You can &ldquo;sniff&rdquo; a file directory or a package: <code>sniff_one()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># crete a directory</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Sys.setenv</span>(A_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;a8d#d%d7g7g4012a4s2&#34;</span>)
</span></span><span style="display:flex;"><span>path <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">file.path</span>(<span style="color:#a6e22e">tempdir</span>(), <span style="color:#e6db74">&#34;foobar&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dir.create</span>(path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># no matches</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sniff_one</span>(path, <span style="color:#a6e22e">Sys.getenv</span>(<span style="color:#e6db74">&#34;A_KEY&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; named list()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># add files with the secret</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cat</span>(<span style="color:#a6e22e">paste0</span>(<span style="color:#e6db74">&#34;foo\nbar\nhello\nworld\n&#34;</span>, 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Sys.getenv</span>(<span style="color:#e6db74">&#34;A_KEY&#34;</span>), <span style="color:#e6db74">&#34;\n&#34;</span>), file <span style="color:#f92672">=</span> <span style="color:#a6e22e">file.path</span>(path, <span style="color:#e6db74">&#34;stuff.R&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># matches! prints the line number where the key was found</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sniff_one</span>(path, <span style="color:#a6e22e">Sys.getenv</span>(<span style="color:#e6db74">&#34;A_KEY&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; $stuff.R</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] 5</span>
</span></span></code></pre></div><h2 id="package">package<a hidden class="anchor" aria-hidden="true" href="#package">#</a></h2>
<p>sniff through a whole package</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>foo <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(key <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.null</span>(key)) key <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;mysecretkey&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">package.skeleton</span>(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mypkg&#34;</span>, list <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>, path <span style="color:#f92672">=</span> <span style="color:#a6e22e">tempdir</span>())
</span></span><span style="display:flex;"><span>pkgpath <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">file.path</span>(<span style="color:#a6e22e">tempdir</span>(), <span style="color:#e6db74">&#34;mypkg&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">list.files</span>(pkgpath, recursive<span style="color:#f92672">=</span><span style="color:#66d9ef">TRUE</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] &#34;DESCRIPTION&#34;          &#34;man/foo.Rd&#34;           &#34;man/mypkg-package.Rd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [4] &#34;NAMESPACE&#34;            &#34;R/foo.R&#34;              &#34;Read-and-delete-me&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check the package</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sniff_secrets_pkg</span>(dir <span style="color:#f92672">=</span> pkgpath, secrets <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;mysecretkey&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; $mysecretkey</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; $mysecretkey$foo.R</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] 3</span>
</span></span></code></pre></div><h2 id="fixtures">fixtures<a hidden class="anchor" aria-hidden="true" href="#fixtures">#</a></h2>
<p>sniff specifically in a package&rsquo;s test fixtures.</p>
<p>Create a package</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>foo <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">function</span>(key <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is.null</span>(key)) key <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;a2s323223asd423adsf4&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">package.skeleton</span>(<span style="color:#e6db74">&#34;herpkg&#34;</span>, list <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;foo&#34;</span>, path <span style="color:#f92672">=</span> <span style="color:#a6e22e">tempdir</span>())
</span></span><span style="display:flex;"><span>pkgpath <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">file.path</span>(<span style="color:#a6e22e">tempdir</span>(), <span style="color:#e6db74">&#34;herpkg&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dir.create</span>(<span style="color:#a6e22e">file.path</span>(pkgpath, <span style="color:#e6db74">&#34;tests/testthat&#34;</span>), recursive <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dir.create</span>(<span style="color:#a6e22e">file.path</span>(pkgpath, <span style="color:#e6db74">&#34;tests/fixtures&#34;</span>), recursive <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cat</span>(<span style="color:#e6db74">&#34;library(vcr)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">vcr::vcr_configure(&#39;../fixtures&#39;, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  filter_sensitive_data = list(&#39;&lt;&lt;mytoken&gt;&gt;&#39; = Sys.getenv(&#39;MY_KEY&#39;))
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">)\n&#34;</span>, file <span style="color:#f92672">=</span> <span style="color:#a6e22e">file.path</span>(pkgpath, <span style="color:#e6db74">&#34;tests/testthat/helper-herpkg.R&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cat</span>(<span style="color:#e6db74">&#34;a2s323223asd423adsf4\n&#34;</span>, 
</span></span><span style="display:flex;"><span>  file <span style="color:#f92672">=</span> <span style="color:#a6e22e">file.path</span>(pkgpath, <span style="color:#e6db74">&#34;tests/fixtures/foo.yml&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check that you have a pkg at herpkg</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">list.files</span>(pkgpath)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] &#34;DESCRIPTION&#34;        &#34;man&#34;                &#34;NAMESPACE&#34;         </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [4] &#34;R&#34;                  &#34;Read-and-delete-me&#34; &#34;tests&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">list.files</span>(<span style="color:#a6e22e">file.path</span>(pkgpath, <span style="color:#e6db74">&#34;tests/testthat&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] &#34;helper-herpkg.R&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cat</span>(<span style="color:#a6e22e">readLines</span>(<span style="color:#a6e22e">file.path</span>(pkgpath, <span style="color:#e6db74">&#34;tests/testthat/helper-herpkg.R&#34;</span>)),
</span></span><span style="display:flex;"><span>  sep <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;\n&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; library(vcr)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; vcr::vcr_configure(&#39;../fixtures&#39;, </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt;   filter_sensitive_data = list(&#39;&lt;&lt;mytoken&gt;&gt;&#39; = Sys.getenv(&#39;MY_KEY&#39;))</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; )</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">list.files</span>(<span style="color:#a6e22e">file.path</span>(pkgpath, <span style="color:#e6db74">&#34;tests/fixtures&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] &#34;foo.yml&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">readLines</span>(<span style="color:#a6e22e">file.path</span>(pkgpath, <span style="color:#e6db74">&#34;tests/fixtures/foo.yml&#34;</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] &#34;a2s323223asd423adsf4&#34;</span>
</span></span></code></pre></div><p>Check the package</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">Sys.setenv</span>(<span style="color:#e6db74">&#39;MY_KEY&#39;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a2s323223asd423adsf4&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sniff_secrets_fixtures</span>(pkgpath)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; $MY_KEY</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; $MY_KEY$foo.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] 1</span>
</span></span></code></pre></div><h2 id="sniffer">sniffer<a hidden class="anchor" aria-hidden="true" href="#sniffer">#</a></h2>
<p>The function <code>sniffer()</code> wraps the function <code>sniff_secrets_fixtures()</code> and
pretty prints to optimize non-interactive use. Run from within R or from the
command line non-interactively.</p>
<p>Example where a secret is found:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">sniffer</span>(pkgpath)
</span></span></code></pre></div><p><img loading="lazy" src="/2020-01-30-test-truffles/found.png" alt="found"  />
</p>
<p>Example where a secret is not found:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">Sys.unsetenv</span>(<span style="color:#e6db74">&#39;MY_KEY&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sniffer</span>(pkgpath)
</span></span></code></pre></div><p><img loading="lazy" src="/2020-01-30-test-truffles/notfound.png" alt="found"  />
</p>
<h2 id="to-do">To do<a hidden class="anchor" aria-hidden="true" href="#to-do">#</a></h2>
<p>There&rsquo;s more to do. trufflesniffer hasn&rsquo;t been tested thoroughly yet; I&rsquo;ll do
more testing to make the experience better. In addition, it&rsquo;d probably be
best to integrate this into the R vcr package so that the user doesn&rsquo;t have to
take an extra step to make sure they aren&rsquo;t going to put any secrets on
the web.</p>
<hr>
<!-- raw HTML omitted -->
<p>ack: trufflesniffer uses R packages <a href="https://github.com/r-lib/cli">cli</a> and <a href="https://github.com/r-lib/crayon">crayon</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/r/">R</a></li>
      <li><a href="http://localhost:1313/tags/testing/">Testing</a></li>
      <li><a href="http://localhost:1313/tags/truffles/">Truffles</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://localhost:1313/">Recology</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
