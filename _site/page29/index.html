<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <link href="http://gmpg.org/xfn/11" rel="profile">

  <title>
    
    Recology, R/etc.
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600,700|Abril+Fatface">

  <link rel="stylesheet" href="/public/css/bootstrap/css/bootstrap.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/favicon.ico">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css" rel="stylesheet">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0f layout-reverse">

    <header class="masthead">
      <div class="masthead-inner">
        <h1>Recology</h1>
        <!-- <h1> <a href="http://recology.info/">Recology</a></h1> -->
        <p class="lead">R/etc.</p>

        <div class="colophon">
          <ul class="colophon-links">
            <li>
              <a href="/"><i class="fa fa-home fa-lg"></i></a>&nbsp;
              <a href="/about"><i class="fa fa-info-circle fa-lg"></i></a>&nbsp;
              <a href="/archives"><i class="fa fa-archive fa-lg"></i></a>&nbsp;
              <a href="/rresources"><i class="fa fa-book fa-lg"></i></a>&nbsp;
              <a href="http://rforcats.net/" rel><i class="fa fa-graduation-cap fa-lg"></i></a>&nbsp;
              <a href="/feed.xml"><i class="fa fa-rss fa-lg"></i></a>&nbsp;
              <a href="https://twitter.com/sckottie"><i class="fa fa-twitter fa-lg"></i></a>&nbsp;
              <a href="/fork"><i class="fa fa-spinner fa-lg"></i></a>
            </li>
          </ul>
          <!-- <small><a href="https://github.com/mdo/hyde">Hyde</a> from <a href="https://twitter.com/mdo" target="_blank">@mdo</a>.</small> -->
        </div>
      </div>
    </header>

    <div class="content container">
      <div class="posts">
  <a style="float:right;" href="/archives" data-toggle="tooltip" data-placement="bottom" title="Archives"><i class="fa fa-archive fa-lg"></i></a>
  <a style="float:right;" href="/tags"><i class="fa fa-tags fa-lg"></i></a>&nbsp;
  
  <div class="post">
    <h1>
      <a href="/2012/10/phylogenetic-tree-balance/">
        Exploring phylogenetic tree balance metrics
      </a>
    </h1>

    <span class="post-date">10 Oct 2012</span>

    <p>I need to simulate balanced and unbalanced phylogenetic trees for some research I am doing.  In order to do this, I do rejection sampling: simulate a tree -&gt; measure tree shape -&gt; reject if not balanced or unbalanced <strong>enough</strong>.  But what is enough?  We need to define some cutoff value to determine what will be our set of balanced and unbalanced trees.</p>

<h3 id="a-function-to-calculate-shape-metrics-and-a-custom-theme-for-plottingn-phylogenies">A function to calculate shape metrics, and a custom theme for plottingn phylogenies.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18</pre></td><td class="code"><pre><span class="n">foo</span> <span class="o">&lt;-</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s2">"colless"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">"colless"</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">xx</span> <span class="o">&lt;-</span> <span class="n">as.treeshape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># convert to apTreeshape format
</span>        <span class="n">colless</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="s2">"yule"</span><span class="p">)</span>  <span class="c1"># calculate colless' metric
</span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">"gamma"</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gammaStat</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="n">stop</span><span class="p">(</span><span class="s2">"metric should be one of colless or gamma"</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">theme_myblank</span> <span class="o">&lt;-</span> <span class="k">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">stopifnot</span><span class="p">(</span><span class="n">require</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">))</span>
    <span class="n">theme_blank</span> <span class="o">&lt;-</span> <span class="n">ggplot2</span><span class="o">::</span><span class="n">theme_blank</span>
    <span class="n">ggplot2</span><span class="o">::</span><span class="n">theme</span><span class="p">(</span><span class="n">panel.grid.major</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> <span class="n">panel.grid.minor</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> 
        <span class="n">panel.background</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> <span class="n">plot.background</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> 
        <span class="n">axis.title.x</span> <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">colour</span> <span class="o">=</span> <span class="n">NA</span><span class="p">),</span> <span class="n">axis.title.y</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> 
        <span class="n">axis.text.x</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> <span class="n">axis.text.y</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> <span class="n">axis.line</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">(),</span> 
        <span class="n">axis.ticks</span> <span class="o">=</span> <span class="n">element_blank</span><span class="p">())</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="simulate-some-trees">Simulate some trees</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="n">library</span><span class="p">(</span><span class="n">ape</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">phytools</span><span class="p">)</span>

<span class="n">numtrees</span> <span class="o">&lt;-</span> <span class="m">1000</span>  <span class="c1"># lets simulate 1000 trees
</span><span class="n">trees</span> <span class="o">&lt;-</span> <span class="n">pbtree</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="m">50</span><span class="p">,</span> <span class="n">nsim</span> <span class="o">=</span> <span class="n">numtrees</span><span class="p">,</span> <span class="n">ape</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span>  <span class="err">#</span> <span class="n">simulate</span> <span class="m">500</span> <span class="n">pure</span><span class="o">-</span><span class="n">birth</span> <span class="n">trees</span> <span class="n">with</span> <span class="m">100</span> <span class="n">spp</span> <span class="n">each</span><span class="p">,</span> <span class="n">ape</span> <span class="o">=</span> <span class="n">F</span> <span class="n">makes</span> <span class="n">it</span> <span class="n">run</span> <span class="n">faster</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="calculate-colless-shape-metric-on-each-tree">Calculate Colless’ shape metric on each tree</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="n">library</span><span class="p">(</span><span class="n">plyr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">apTreeshape</span><span class="p">)</span>

<span class="n">colless_df</span> <span class="o">&lt;-</span> <span class="n">ldply</span><span class="p">(</span><span class="n">trees</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="s2">"colless"</span><span class="p">)</span>  <span class="c1"># calculate metric for each tree
</span><span class="n">head</span><span class="p">(</span><span class="n">colless_df</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">       V1
1 -0.1761
2  0.2839
3  0.4639
4  0.9439
5 -0.6961
6 -0.1161</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="c1"># Calculate the percent of trees that will fall into the cutoff for balanced and unbalanced trees
</span><span class="n">col_percent_low</span> <span class="o">&lt;-</span> <span class="n">round</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">colless_df</span><span class="p">[</span><span class="n">colless_df</span><span class="o">$</span><span class="n">V1</span> <span class="o">&lt;</span> <span class="m">-0.7</span><span class="p">,</span> <span class="s2">"V1"</span><span class="p">])</span><span class="o">/</span><span class="n">numtrees</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span> <span class="o">*</span> <span class="m">100</span>
<span class="n">col_percent_high</span> <span class="o">&lt;-</span> <span class="n">round</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">colless_df</span><span class="p">[</span><span class="n">colless_df</span><span class="o">$</span><span class="n">V1</span> <span class="o">&gt;</span> <span class="m">0.7</span><span class="p">,</span> <span class="s2">"V1"</span><span class="p">])</span><span class="o">/</span><span class="n">numtrees</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span> <span class="o">*</span> <span class="m">100</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="create-a-distribution-of-the-metric-values">Create a distribution of the metric values</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>

<span class="n">a</span> <span class="o">&lt;-</span> <span class="n">ggplot</span><span class="p">(</span><span class="n">colless_df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">V1</span><span class="p">))</span> <span class="o">+</span>  <span class="c1"># plot histogram of distribution of values
</span>	<span class="n">geom_histogram</span><span class="p">()</span> <span class="o">+</span> 
	<span class="n">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">18</span><span class="p">)</span> <span class="o">+</span> 
	<span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">-3</span><span class="p">,</span><span class="m">3</span><span class="p">),</span> <span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">-3</span><span class="p">,</span><span class="m">-2</span><span class="p">,</span><span class="m">-1</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">))</span> <span class="o">+</span> 
	<span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="m">-0.7</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="s2">"longdash"</span><span class="p">)</span> <span class="o">+</span>
	<span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="m">0.7</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="s2">"longdash"</span><span class="p">)</span> <span class="o">+</span>
	<span class="n">ggtitle</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Distribution of Colless' metric for 1000 trees, cutoffs at -0.7 and 0.7 results in\n "</span><span class="p">,</span> <span class="n">col_percent_low</span><span class="p">,</span> <span class="s2">"% ("</span><span class="p">,</span> <span class="n">numtrees</span><span class="o">*</span><span class="p">(</span><span class="n">col_percent_low</span><span class="o">/</span><span class="m">100</span><span class="p">),</span> <span class="s2">") 'balanced' trees (left) and "</span><span class="p">,</span> <span class="n">col_percent_low</span><span class="p">,</span> <span class="s2">"% ("</span><span class="p">,</span> <span class="n">numtrees</span><span class="o">*</span><span class="p">(</span><span class="n">col_percent_low</span><span class="o">/</span><span class="m">100</span><span class="p">),</span> <span class="s2">") 'unbalanced' trees (right)"</span><span class="p">))</span> <span class="o">+</span>  
	<span class="n">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">"Colless' Metric Value"</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">"Number of phylogenetic trees"</span><span class="p">)</span> <span class="o">+</span>
	<span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span>  <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">16</span><span class="p">))</span>

<span class="n">a</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/collesshist.png" alt="center" /></p>

<h3 id="create-phylogenies-representing-balanced-and-unbalanced-trees-using-the-custom-theme">Create phylogenies representing balanced and unbalanced trees (using the custom theme)</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="n">library</span><span class="p">(</span><span class="n">ggphylo</span><span class="p">)</span>

<span class="n">b</span> <span class="o">&lt;-</span> <span class="n">ggphylo</span><span class="p">(</span><span class="n">trees</span><span class="p">[</span><span class="n">which.min</span><span class="p">(</span><span class="n">colless_df</span><span class="o">$</span><span class="n">V1</span><span class="p">)],</span> <span class="n">do.plot</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span> <span class="o">+</span> <span class="n">theme_myblank</span><span class="p">()</span>
<span class="n">c</span> <span class="o">&lt;-</span> <span class="n">ggphylo</span><span class="p">(</span><span class="n">trees</span><span class="p">[</span><span class="n">which.max</span><span class="p">(</span><span class="n">colless_df</span><span class="o">$</span><span class="n">V1</span><span class="p">)],</span> <span class="n">do.plot</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span> <span class="o">+</span> <span class="n">theme_myblank</span><span class="p">()</span>

<span class="n">b</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/collessphylog.png" alt="center" /></p>

<h3 id="now-put-it-all-together-in-one-plot-using-some-gridextra-magic">Now, put it all together in one plot using some gridExtra magic.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10</pre></td><td class="code"><pre><span class="n">library</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">)</span>

<span class="n">grid.newpage</span><span class="p">()</span>
<span class="n">pushViewport</span><span class="p">(</span><span class="n">viewport</span><span class="p">(</span><span class="n">layout</span> <span class="o">=</span> <span class="n">grid.layout</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)))</span>
<span class="n">vpa_</span> <span class="o">&lt;-</span> <span class="n">viewport</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="m">0.49</span><span class="p">)</span>
<span class="n">vpb_</span> <span class="o">&lt;-</span> <span class="n">viewport</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="m">0.35</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="m">0.35</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="m">0.23</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="m">0.7</span><span class="p">)</span>
<span class="n">vpc_</span> <span class="o">&lt;-</span> <span class="n">viewport</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="m">0.35</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="m">0.35</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="m">0.82</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="m">0.7</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">vp</span> <span class="o">=</span> <span class="n">vpa_</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">vp</span> <span class="o">=</span> <span class="n">vpb_</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">vp</span> <span class="o">=</span> <span class="n">vpc_</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/collessall.png" alt="center" /></p>

<h3 id="and-the-same-for-gamma-stat-which-measures-the-distribution-of-nodes-in-time">And the same for Gamma stat, which measures the distribution of nodes in time.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></td><td class="code"><pre><span class="n">gamma_df</span> <span class="o">&lt;-</span> <span class="n">ldply</span><span class="p">(</span><span class="n">trees</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s2">"gamma"</span><span class="p">)</span> <span class="c1"># calculate metric for each tree
</span><span class="n">gam_percent_low</span> <span class="o">&lt;-</span> <span class="n">round</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">gamma_df</span><span class="p">[</span><span class="n">gamma_df</span><span class="o">$</span><span class="n">V1</span> <span class="o">&lt;</span> <span class="m">-1</span><span class="p">,</span> <span class="s2">"V1"</span><span class="p">])</span><span class="o">/</span><span class="n">numtrees</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span><span class="o">*</span><span class="m">100</span>
<span class="n">gam_percent_high</span> <span class="o">&lt;-</span> <span class="n">round</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">gamma_df</span><span class="p">[</span><span class="n">gamma_df</span><span class="o">$</span><span class="n">V1</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">,</span> <span class="s2">"V1"</span><span class="p">])</span><span class="o">/</span><span class="n">numtrees</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span><span class="o">*</span><span class="m">100</span>
<span class="n">a</span> <span class="o">&lt;-</span> <span class="n">ggplot</span><span class="p">(</span><span class="n">gamma_df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">V1</span><span class="p">))</span> <span class="o">+</span>  <span class="c1"># plot histogram of distribution of values
</span>	<span class="n">geom_histogram</span><span class="p">()</span> <span class="o">+</span> 
	<span class="n">theme_bw</span><span class="p">(</span><span class="n">base_size</span><span class="o">=</span><span class="m">18</span><span class="p">)</span> <span class="o">+</span> 
	<span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">c</span><span class="p">(</span><span class="m">-3</span><span class="p">,</span><span class="m">-2</span><span class="p">,</span><span class="m">-1</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">))</span> <span class="o">+</span> 
	<span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="m">-1</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="s2">"longdash"</span><span class="p">)</span> <span class="o">+</span>
	<span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">linetype</span> <span class="o">=</span> <span class="s2">"longdash"</span><span class="p">)</span> <span class="o">+</span>
	<span class="n">ggtitle</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Distribution of Gamma metric for 1000 trees, cutoffs at -1 and 1 results in\n "</span><span class="p">,</span> <span class="n">gam_percent_low</span><span class="p">,</span> <span class="s2">"% ("</span><span class="p">,</span> <span class="n">numtrees</span><span class="o">*</span><span class="p">(</span><span class="n">gam_percent_low</span><span class="o">/</span><span class="m">100</span><span class="p">),</span> <span class="s2">") trees with deeper nodes (left) and "</span><span class="p">,</span> <span class="n">gam_percent_high</span><span class="p">,</span> <span class="s2">"% ("</span><span class="p">,</span> <span class="n">numtrees</span><span class="o">*</span><span class="p">(</span><span class="n">gam_percent_high</span><span class="o">/</span><span class="m">100</span><span class="p">),</span> <span class="s2">") trees with shallower nodes (right)"</span><span class="p">))</span> <span class="o">+</span>  
	<span class="n">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s2">"Gamma Metric Value"</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">"Number of phylogenetic trees"</span><span class="p">)</span> <span class="o">+</span>
	<span class="n">theme</span><span class="p">(</span><span class="n">plot.title</span>  <span class="o">=</span> <span class="n">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">16</span><span class="p">))</span>
<span class="n">b</span> <span class="o">&lt;-</span> <span class="n">ggphylo</span><span class="p">(</span><span class="n">trees</span><span class="p">[</span><span class="n">which.min</span><span class="p">(</span><span class="n">gamma_df</span><span class="o">$</span><span class="n">V1</span><span class="p">)],</span> <span class="n">do.plot</span><span class="o">=</span><span class="n">F</span><span class="p">)</span> <span class="o">+</span> <span class="n">theme_myblank</span><span class="p">()</span>
<span class="n">c</span> <span class="o">&lt;-</span> <span class="n">ggphylo</span><span class="p">(</span><span class="n">trees</span><span class="p">[</span><span class="n">which.max</span><span class="p">(</span><span class="n">gamma_df</span><span class="o">$</span><span class="n">V1</span><span class="p">)],</span> <span class="n">do.plot</span><span class="o">=</span><span class="n">F</span><span class="p">)</span> <span class="o">+</span> <span class="n">theme_myblank</span><span class="p">()</span>

<span class="n">grid.newpage</span><span class="p">()</span>
<span class="n">pushViewport</span><span class="p">(</span><span class="n">viewport</span><span class="p">(</span><span class="n">layout</span> <span class="o">=</span> <span class="n">grid.layout</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">)))</span>
<span class="n">vpa_</span> <span class="o">&lt;-</span> <span class="n">viewport</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="m">0.49</span><span class="p">)</span>
<span class="n">vpb_</span> <span class="o">&lt;-</span> <span class="n">viewport</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="m">0.35</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="m">0.35</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="m">0.23</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="m">0.7</span><span class="p">)</span>
<span class="n">vpc_</span> <span class="o">&lt;-</span> <span class="n">viewport</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="m">0.35</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="m">0.35</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="m">0.82</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="m">0.7</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">vp</span> <span class="o">=</span> <span class="n">vpa_</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">vp</span> <span class="o">=</span> <span class="n">vpb_</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">vp</span> <span class="o">=</span> <span class="n">vpc_</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/gammaall.png" alt="center" /></p>

<hr />
<p>#### Get the .Rmd file used to create this post <a href="https://github.com/sckott/sckott.github.com/tree/master/_drafts/2012-10-10-phylogenetic-tree-balance.Rmd">at my github account</a> - or <a href="https://github.com/sckott/sckott.github.com/tree/master/_posts/2012-10-10-phylogenetic-tree-balance.md">.md file</a>.</p>

<h4 id="written-in-markdownhttpdaringfireballnetprojectsmarkdown-with-help-from-knitrhttpyihuinameknitr">Written in <a href="http://daringfireball.net/projects/markdown/">Markdown</a>, with help from <a href="http://yihui.name/knitr/">knitr</a>.</h4>

  </div>
  
  <div class="post">
    <h1>
      <a href="/2012/10/rgbif-newfxns/">
        GBIF biodiversity data from R - more functions
      </a>
    </h1>

    <span class="post-date">08 Oct 2012</span>

    <h4 id="update-in-response-to-jarretts-query-i-laid-out-a-separate-use-case-in-which-you-may-want-to-query-by-higher-taxonomic-rankings-than-species-see-below--in-addition-added-examples-of-querying-by-location-in-reply-to-comments-by-seminym">UPDATE: In response to Jarrett’s query I laid out a separate use case in which you may want to query by higher taxonomic rankings than species. See below.  In addition, added examples of querying by location in reply to comments by seminym.</h4>

<hr />

<p>We have been working on an R package to get GBIF data from R, with the stable version available through CRAN <a href="URL">here</a>, and the development version available on GitHub <a href="http://github.com/rgbif">here</a>.</p>

<p>We had a Google Summer of code stuent work on the package this summer - you can see his work on the package over at his GitHub page <a href="">here</a>.  We have added some new functionality since his work, and would like to show it off.</p>

<h3 id="lets-install-rgbif-first">Lets install rgbif first.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="c1"># install_github('rgbif', 'ropensci') # uncomment if not already installed
</span><span class="n">library</span><span class="p">(</span><span class="n">rgbif</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">plyr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">XML</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">httr</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">maps</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="get-taxonomic-information-on-a-specific-taxon-or-taxa-in-gbif-by-their-taxon-concept-keys">Get taxonomic information on a specific taxon or taxa in GBIF by their taxon concept keys.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="p">(</span><span class="n">keys</span> <span class="o">&lt;-</span> <span class="n">taxonsearch</span><span class="p">(</span><span class="n">scientificname</span> <span class="o">=</span> <span class="s2">"Puma concolor"</span><span class="p">))</span>  <span class="err">#</span> <span class="n">many</span> <span class="n">matches</span> <span class="n">to</span> <span class="n">this</span> <span class="n">search</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [1] "51780668" "51758018" "50010499" "51773067" "51078815" "51798065"
 [7] "51088007" "50410780" "50305290" "51791438"</code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">taxonget</span><span class="p">(</span><span class="n">keys</span><span class="p">[[</span><span class="m">1</span><span class="p">]])</span>  <span class="err">#</span> <span class="n">let</span><span class="err">'</span><span class="n">s</span> <span class="n">get</span> <span class="n">the</span> <span class="n">first</span> <span class="n">one</span> <span class="o">-</span> <span class="n">the</span> <span class="n">first</span> <span class="n">row</span> <span class="k">in</span> <span class="n">the</span> <span class="n">data.frame</span> <span class="n">is</span> <span class="n">the</span> <span class="n">one</span> <span class="n">we</span> <span class="n">searched</span> <span class="k">for</span> <span class="p">(</span><span class="m">51780668</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[[1]]
                    sciname taxonconceptkeys       rank
1             Puma concolor         51780668    species
2                      Puma         51780667      genus
3                   Felidae         51780651     family
4                 Carnivora         51780613      order
5                  Mammalia         51780547      class
6                  Chordata         51775774     phylum
7                  Animalia         51775773    kingdom
8 Puma concolor californica         51780669 subspecies
9   Puma concolor improcera         51780670 subspecies</code></pre></figure>

<h3 id="the-occurrencedensity-function-was-renamed-to-densitylist-because-it-is-in-the-density-api-service-not-the-occurrence-api-service--you-can-use-densitylist-to-get-a-dataframe-of-total-occurrence-counts-by-one-degree-cell-for-a-single-taxon-country-dataset-data-publisher-or-data-network--just-a-quick-reminder-of-what-the-function-can-do">The <code class="highlighter-rouge">occurrencedensity</code> function was renamed to <code class="highlighter-rouge">densitylist</code> because it is in the <code class="highlighter-rouge">density</code> API service, not the <code class="highlighter-rouge">occurrence</code> API service.  You can use <code class="highlighter-rouge">densitylist</code> to get a data.frame of total occurrence counts by one-degree cell for a single taxon, country, dataset, data publisher or data network.  Just a quick reminder of what the function can do:</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">head</span><span class="p">(</span><span class="n">densitylist</span><span class="p">(</span><span class="n">originisocountrycode</span> <span class="o">=</span> <span class="s2">"CA"</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  cellid minLatitude maxLatitude minLongitude maxLongitude count
1  46913          40          41          -67          -66    44
2  46914          40          41          -66          -65   907
3  46915          40          41          -65          -64   510
4  46916          40          41          -64          -63   645
5  46917          40          41          -63          -62    56
6  46918          40          41          -62          -61   143</code></pre></figure>

<h3 id="using-a-related-function-densityspplist-you-can-get-a-species-list-by-one-degree-cell-as-well">Using a related function, <code class="highlighter-rouge">density_spplist</code>, you can get a species list by one-degree cell as well.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1"># Get a species list by cell, choosing one at random
</span><span class="n">density_spplist</span><span class="p">(</span><span class="n">originisocountrycode</span> <span class="o">=</span> <span class="s2">"CO"</span><span class="p">,</span> <span class="n">spplist</span> <span class="o">=</span> <span class="s2">"random"</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [1] "Abarema laeta (Benth.) Barneby &amp; J.W.Grimes"
 [2] "Abuta grandifolia (Mart.) Sandwith"         
 [3] "Acalypha cuneata Poepp."                    
 [4] "Acalypha diversifolia Jacq."                
 [5] "Acalypha macrostachya Jacq."                
 [6] "Acalypha stachyura Pax"                     
 [7] "Acanthoscelio acutus"                       
 [8] "Accipiter collaris"                         
 [9] "Actitis macularia"                          
[10] "Adelobotrys klugii Wurdack"                 </code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c1"># density_spplist(originisocountrycode = 'CO', spplist = 'r') # can
# abbreviate the `spplist` argument
</span>
<span class="c1"># Get a species list by cell, choosing the one with the greatest no. of
# records
</span><span class="n">density_spplist</span><span class="p">(</span><span class="n">originisocountrycode</span> <span class="o">=</span> <span class="s2">"CO"</span><span class="p">,</span> <span class="n">spplist</span> <span class="o">=</span> <span class="s2">"great"</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">]</span>  <span class="err">#</span> <span class="n">great</span> <span class="n">is</span> <span class="n">abbreviated</span> <span class="n">from</span> <span class="sb">`greatest`</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> [1] "Acanthaceae Juss."                
 [2] "Accipitridae sp."                 
 [3] "Accipitriformes/Falconiformes sp."
 [4] "Apodidae sp."                     
 [5] "Apodidae sp. (large swift sp.)"   
 [6] "Apodidae sp. (small swift sp.)"   
 [7] "Arctiinae"                        
 [8] "Asteraceae Bercht. &amp; J. Presl"    
 [9] "Asteraceae sp. 1"                 
[10] "Asteraceae sp. 6"                 </code></pre></figure>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="c1"># Can also get a data.frame with counts instead of the species list
</span><span class="n">density_spplist</span><span class="p">(</span><span class="n">originisocountrycode</span> <span class="o">=</span> <span class="s2">"CO"</span><span class="p">,</span> <span class="n">spplist</span> <span class="o">=</span> <span class="s2">"great"</span><span class="p">,</span> <span class="n">listcount</span> <span class="o">=</span> <span class="s2">"counts"</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">,</span> 
    <span class="p">]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">                              names_ count
1                  Acanthaceae Juss.     2
2                   Accipitridae sp.     6
3  Accipitriformes/Falconiformes sp.     2
4                       Apodidae sp.     5
5     Apodidae sp. (large swift sp.)     8
6     Apodidae sp. (small swift sp.)     5
7                          Arctiinae     7
8      Asteraceae Bercht. &amp; J. Presl     2
9                   Asteraceae sp. 1     6
10                  Asteraceae sp. 6    10</code></pre></figure>

<h3 id="you-can-now-map-point-results-from-fxns-occurrencelist-and-those-from-densitylist-which-plots-them-as-points-or-as-tiles-respectively--point-map-using-output-from-occurrencelist">You can now map point results, from fxns <code class="highlighter-rouge">occurrencelist</code> and those from <code class="highlighter-rouge">densitylist</code>, which plots them as points or as tiles, respectively.  Point map, using output from occurrencelist.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="n">out</span> <span class="o">&lt;-</span> <span class="n">occurrencelist</span><span class="p">(</span><span class="n">scientificname</span> <span class="o">=</span> <span class="s2">"Puma concolor"</span><span class="p">,</span> <span class="n">coordinatestatus</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span> 
    <span class="n">maxresults</span> <span class="o">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">latlongdf</span> <span class="o">=</span> <span class="n">T</span><span class="p">)</span>
<span class="n">gbifmap</span><span class="p">(</span><span class="n">input</span> <span class="o">=</span> <span class="n">out</span><span class="p">)</span>  <span class="err">#</span> <span class="n">make</span> <span class="n">a</span> <span class="n">map</span><span class="p">,</span> <span class="n">plotting</span> <span class="n">on</span> <span class="n">world</span> <span class="n">map</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/gbifmap1.png" alt="center" /></p>

<h3 id="point-map-using-output-from-occurrencelist-with-many-species-plotted-as-different-colors">Point map, using output from occurrencelist, with many species plotted as different colors</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="n">splist</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="p">(</span><span class="s2">"Accipiter erythronemius"</span><span class="p">,</span> <span class="s2">"Junco hyemalis"</span><span class="p">,</span> <span class="s2">"Aix sponsa"</span><span class="p">,</span> <span class="s2">"Buteo regalis"</span><span class="p">)</span>
<span class="n">out</span> <span class="o">&lt;-</span> <span class="n">lapply</span><span class="p">(</span><span class="n">splist</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">occurrencelist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">coordinatestatus</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">maxresults</span> <span class="o">=</span> <span class="m">100</span><span class="p">,</span> 
    <span class="n">latlongdf</span> <span class="o">=</span> <span class="n">T</span><span class="p">))</span>
<span class="n">gbifmap</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/gbifmap2.png" alt="center" /></p>

<h3 id="tile-map-using-output-from-densitylist-using-results-in-canada-only">Tile map, using output from densitylist, using results in Canada only.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">out2</span> <span class="o">&lt;-</span> <span class="n">densitylist</span><span class="p">(</span><span class="n">originisocountrycode</span> <span class="o">=</span> <span class="s2">"CA"</span><span class="p">)</span>  <span class="c1"># data for Canada
</span><span class="n">gbifmap</span><span class="p">(</span><span class="n">out2</span><span class="p">)</span>  <span class="err">#</span> <span class="n">on</span> <span class="n">world</span> <span class="n">map</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/gbifmap31.png" alt="center" /></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">gbifmap</span><span class="p">(</span><span class="n">out2</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="s2">"Canada"</span><span class="p">)</span>  <span class="err">#</span> <span class="n">on</span> <span class="n">Canada</span> <span class="n">map</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/gbifmap32.png" alt="NA" /></p>

<hr />

<h3 id="we-can-also-query-by-higher-taxonomic-rankings-and-map-all-lower-species-within-that-ranking-above-we-queried-by-scientificname-but-we-can-also-query-by-higher-taxonomy-7071443-is-the-taxonconceptkey-for-bacillariophyceae-a-class-which-includes-many-lower-species">We can also query by higher taxonomic rankings, and map all lower species within that ranking. Above we queried by scientificname, but we can also query by higher taxonomy. 7071443 is the taxonconceptkey for ‘Bacillariophyceae’, a Class which includes many lower species.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">out</span> <span class="o">&lt;-</span> <span class="n">densitylist</span><span class="p">(</span><span class="n">taxonconceptKey</span> <span class="o">=</span> <span class="m">7071443</span><span class="p">)</span>
<span class="n">gbifmap</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/algae.png" alt="center" /></p>

<h3 id="seminym-asked-about-querying-by-area-you-can-query-by-area-though-slightly-differently-for-occurrencelist-and-densitylist-functions-for-occurrencelist-you-can-search-using-min-and-max-lat-and-long-values-and-min-an-max-altitude-pretty-cool-eh">seminym asked about querying by area. You can query by area, though slightly differently for occurrencelist and densitylist functions. For occurrencelist you can search using min and max lat and long values (and min an max altitude, pretty cool, eh).</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="c1"># Get occurrences or density by area, using min/max lat/long coordinates
</span><span class="n">out</span> <span class="o">&lt;-</span> <span class="n">occurrencelist</span><span class="p">(</span><span class="n">minlatitude</span> <span class="o">=</span> <span class="m">30</span><span class="p">,</span> <span class="n">maxlatitude</span> <span class="o">=</span> <span class="m">35</span><span class="p">,</span> <span class="n">minlongitude</span> <span class="o">=</span> <span class="m">-100</span><span class="p">,</span> 
    <span class="n">maxlongitude</span> <span class="o">=</span> <span class="m">-95</span><span class="p">,</span> <span class="n">coordinatestatus</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">maxresults</span> <span class="o">=</span> <span class="m">5000</span><span class="p">,</span> <span class="n">latlongdf</span> <span class="o">=</span> <span class="n">T</span><span class="p">)</span>

<span class="c1"># Using `geom_point`
</span><span class="n">gbifmap</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">"state"</span><span class="p">,</span> <span class="s2">"texas"</span><span class="p">,</span> <span class="n">geom_point</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/byarea_occurr1.png" alt="center" /></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1"># Using geom_jitter to move the points apart from one another
</span><span class="n">gbifmap</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">"state"</span><span class="p">,</span> <span class="s2">"texas"</span><span class="p">,</span> <span class="n">geom_jitter</span><span class="p">,</span> <span class="n">position_jitter</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="m">0.3</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="m">0.3</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/byarea_occurr2.png" alt="NA" /></p>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="c1"># And move points a lot
</span><span class="n">gbifmap</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s2">"state"</span><span class="p">,</span> <span class="s2">"texas"</span><span class="p">,</span> <span class="n">geom_jitter</span><span class="p">,</span> <span class="n">position_jitter</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="m">1</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/byarea_occurr3.png" alt="NA" /></p>

<h3 id="and-you-can-query-by-area-in-densitylist-by-specifying-a-place-using-the-originisocountrycode-argument-as-done-in-an-above-example--just-showing-the-head-of-the-dataframe-here">And you can query by area in <code class="highlighter-rouge">densitylist</code> by specifying a place using the <code class="highlighter-rouge">originisocountrycode</code> argument (as done in an above example).  Just showing the head of the data.frame here.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="c1"># Get density by place, note that you can't use the lat and long arguments
# in densitylist
</span><span class="n">head</span><span class="p">(</span><span class="n">densitylist</span><span class="p">(</span><span class="n">originisocountrycode</span> <span class="o">=</span> <span class="s2">"CA"</span><span class="p">))</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">  cellid minLatitude maxLatitude minLongitude maxLongitude count
1  46913          40          41          -67          -66    44
2  46914          40          41          -66          -65   907
3  46915          40          41          -65          -64   510
4  46916          40          41          -64          -63   645
5  46917          40          41          -63          -62    56
6  46918          40          41          -62          -61   143</code></pre></figure>

<hr />
<p>#### Get the .Rmd file used to create this post <a href="https://github.com/sckott/sckott.github.com/tree/master/_drafts/2012-10-08-rgbif-newfxns.Rmd">at my github account</a> - or <a href="https://github.com/sckott/sckott.github.com/tree/master/_posts/2012-10-08-rgbif-newfxns.md">.md file</a>.</p>

<h4 id="written-in-markdownhttpdaringfireballnetprojectsmarkdown-with-help-from-knitrhttpyihuinameknitr">Written in <a href="http://daringfireball.net/projects/markdown/">Markdown</a>, with help from <a href="http://yihui.name/knitr/">knitr</a>.</h4>

  </div>
  
  <div class="post">
    <h1>
      <a href="/2012/09/rvertnet/">
        Vertnet - getting vertebrate museum record data and a quick map
      </a>
    </h1>

    <span class="post-date">19 Sep 2012</span>

    <p>We (<a href="http://ropensci.org/">rOpenSci</a>) started a repo to wrap the API for <a href="http://vertnet.org/index.php">VertNet</a>, an open access online database of vertebrate specimen records across many collection holders. Find the open source code <a href="https://github.com/ropensci/rvertnet">here</a> - please contribute if you are so inclined.  We had a great Google Summer of Code student, <a href="http://vijaybarve.wordpress.com/">Vijay Barve</a> contributing to the repo this summer, so it is getting close to being CRAN-able.</p>

<p>Most of the functions in the repo get you the raw data, but there were no functions to visualize the data.  Since much of the data records of latitude and longitude data, maps are a natural visualization to use.</p>

<p>What follows is a quick example of using the basic <code class="highlighter-rouge">vertmap</code> function.</p>

<h3 id="first-lets-install-rvertnet">First, let’s install <code class="highlighter-rouge">rvertnet</code></h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="c1"># install_github('rvertnet', 'ropensci') # uncomment if not installed
# already
</span><span class="n">library</span><span class="p">(</span><span class="n">rvertnet</span><span class="p">)</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="first-lets-get-some-data-using-vertoccurrence">First, let’s get some data using <code class="highlighter-rouge">vertoccurrence</code></h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">out</span> <span class="o">&lt;-</span> <span class="n">vertoccurrence</span><span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="s2">"larva"</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="m">100</span><span class="p">)</span>  <span class="c1"># get records on keyword 'larva', limit to 100
</span><span class="n">nrow</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>  <span class="err">#</span> <span class="n">how</span> <span class="n">many</span> <span class="n">rows</span><span class="o">?</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[1] 100</code></pre></figure>

<h3 id="now-map-it-using-vertmap--this-is-a-very-basic-function-it-simply-cleans-up-the-input-dataframe-removing-rows-without-latlong-data-and-providing-warnings-when-the-input-dataframe-is-not-in-the-correct-format--vertmap-uses-the-ggplot2-framework-for-the-map--if-you-want-to-make-you-own-map-please-do-so----this-is-just-a-simple-fxn-to-get-you-started-if-you-want-to-take-a-quick-look-at-the-data">Now map it using <code class="highlighter-rouge">vertmap</code>.  This is a very basic function: it simply cleans up the input data.frame, removing rows without lat/long data, and providing warnings when the input data.frame is not in the correct format.  <code class="highlighter-rouge">vertmap</code> uses the <code class="highlighter-rouge">ggplot2</code> framework for the map.  If you want to make you own map please do so -  this is just a simple fxn to get you started if you want to take a quick look at the data.</h3>

<figure class="highlight"><pre><code class="language-r" data-lang="r"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="n">vertmap</span><span class="p">(</span><span class="n">input</span> <span class="o">=</span> <span class="n">out</span><span class="p">)</span>  <span class="err">#</span> <span class="n">make</span> <span class="n">a</span> <span class="n">map</span> <span class="n">using</span> <span class="n">vertmap</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p><img src="/public/img/vertmap.png" alt="center" /></p>

<hr />
<p>#### Get the .Rmd file used to create this post <a href="https://github.com/sckott/sckott.github.com/tree/master/_drafts/2012-09-19-rvertnet.Rmd">at my github account</a> - or <a href="https://github.com/sckott/sckott.github.com/tree/master/_posts/2012-09-19-rvertnet.md">.md file</a>.</p>

<h4 id="written-in-markdownhttpdaringfireballnetprojectsmarkdown-with-help-from-knitrhttpyihuinameknitr-and-nice-knitr-highlightingetc-in-in-rstudiohttprstudioorg">Written in <a href="http://daringfireball.net/projects/markdown/">Markdown</a>, with help from <a href="http://yihui.name/knitr/">knitr</a>, and nice knitr highlighting/etc. in in <a href="http://rstudio.org/">RStudio</a>.</h4>

  </div>
  
</div>

<!-- Pagination links -->
<div class="pagination">
  
    <a href="/page30" class="older">Older</a>
  
  
    
      <a href="/page28" class="newer">Newer</a>
    
  
</div>

    </div>

    <!-- for bootstrap tooltips -->
    <script type="text/javascript">
      $("[data-toggle=\"tooltip\"]").tooltip();
    </script>

  </body>

  <footer>
  <!-- Disqus code -->
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'recology'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function () {
          var s = document.createElement('script'); s.async = true;
          s.type = 'text/javascript';
          s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
          (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
      }());
  </script>

  <!-- google analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-63197374-1', 'auto');
    ga('send', 'pageview');
  </script>
</footer>

</html>
